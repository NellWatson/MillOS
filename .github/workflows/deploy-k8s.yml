name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}

      - name: Update image tag
        working-directory: scada-proxy/k8s
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository }}/scada-proxy:${{ inputs.version }}"
          kustomize edit set image millos/scada-proxy="$IMAGE_NAME"

      - name: Apply to cluster
        working-directory: scada-proxy/k8s
        run: kubectl apply -k .

      - name: Wait for rollout
        run: kubectl rollout status deployment/scada-proxy -n millos-scada --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get pods -n millos-scada -l app.kubernetes.io/name=scada-proxy
          kubectl get svc -n millos-scada

      - name: Run smoke tests
        run: |
          # Port forward for testing
          kubectl port-forward svc/scada-proxy 3001:3001 -n millos-scada &
          PF_PID=$!
          sleep 5

          # Health check
          curl -f http://localhost:3001/health || exit 1

          kill $PF_PID || true
          echo "Deployment verified successfully"
